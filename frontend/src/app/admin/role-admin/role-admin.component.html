<div class="role-admin">

  <div class="header">
    <div class="titles">
      <h1>Gestion des r√¥les & permissions</h1>
      <p>
        Assigne les droits <b>CONSULT / CREATE / UPDATE / DELETE</b>
        aux profils utilisateurs.
      </p>
    </div>

    <button
      class="btn-primary"
      (click)="save()"
      [disabled]="!selectedProfil || saving"
    >
      <span *ngIf="!saving">üíæ Enregistrer les permissions</span>
      <span *ngIf="saving">‚è≥ Enregistrement...</span>
    </button>
  </div>

  <div class="content">

    <!-- COLONNE GAUCHE : PROFILS -->
    <div class="profils-card">
      <div class="card-header">
        <h2>Profils</h2>
        <input
          type="text"
          placeholder="Rechercher un profil..."
          [(ngModel)]="profilSearch"
        />
      </div>

      <div class="profil-list" *ngIf="!loadingProfils; else loadingProfilsTpl">
        <button
          class="profil-item"
          *ngFor="let p of filteredProfils()"
          (click)="selectProfil(p)"
          [class.active]="selectedProfil?.id === p.id"
        >
          <div class="avatar">
            {{ getProfilInitials(p) }}
          </div>
          <div class="info">
            <div class="libelle">{{ p.libelle }}</div>
            <div class="code">{{ p.code }}</div>
          </div>
        </button>

        <div *ngIf="filteredProfils().length === 0" class="empty">
          Aucun profil trouv√©.
        </div>
      </div>

      <ng-template #loadingProfilsTpl>
        <div class="loading">Chargement des profils...</div>
      </ng-template>
    </div>

    <!-- COLONNE DROITE : ROLES -->
    <div class="roles-card">
      <div *ngIf="selectedProfil; else noProfilTpl">

        <div class="card-header">
          <div>
            <h2>R√¥les disponibles</h2>
            <p>
              Profil s√©lectionn√© :
              <span class="badge">{{ selectedProfil?.libelle }} ({{ selectedProfil?.code }})</span>
            </p>
          </div>
        </div>

        <div class="roles-table-wrapper" *ngIf="!loadingRoles; else loadingRolesTpl">

          <table class="roles-table">
            <thead>
            <tr>
              <th>Code</th>
              <th>Libell√©</th>
              <th>Action</th>
              <th>Menu</th>
              <th>Environnement</th>
              <th>Assign√©</th>
            </tr>
            </thead>
            <tbody>
            <tr *ngFor="let r of roles">
              <td>{{ r.code }}</td>
              <td>{{ r.libelle }}</td>
              <td>
                <span class="chip chip-action">{{ r.action }}</span>
              </td>
              <td>{{ r.menuCode || '‚Äî' }}</td>
              <td>{{ r.environnementCode || '‚Äî' }}</td>
              <td class="center">
                <input
                  type="checkbox"
                  [checked]="isRoleSelected(r.id)"
                  (change)="toggleRole(r.id, $event.target.checked)"
                />
              </td>
            </tr>
            </tbody>
          </table>

          <div *ngIf="roles.length === 0" class="empty">
            Aucun r√¥le configur√© pour le moment.
          </div>
        </div>

        <ng-template #loadingRolesTpl>
          <div class="loading">Chargement des r√¥les...</div>
        </ng-template>

      </div>

      <ng-template #noProfilTpl>
        <div class="no-selection">
          <p>S√©lectionne un profil √† gauche pour g√©rer ses r√¥les.</p>
        </div>
      </ng-template>
    </div>

  </div>
</div>
