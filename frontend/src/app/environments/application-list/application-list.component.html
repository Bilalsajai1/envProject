<div class="application-list-container">

  <!-- Breadcrumb -->
  <nav class="breadcrumb">
    <mat-icon>home</mat-icon>
    <span>{{ typeCode }}</span>

    <mat-icon>chevron_right</mat-icon>
    <a (click)="goBack()" class="breadcrumb-link">Environnements</a>

    <mat-icon>chevron_right</mat-icon>
    <span class="current">Env #{{ environmentId }}</span>
  </nav>

  <!-- Header -->
  <div class="list-header">
    <div>
      <h2>
        <mat-icon>apps</mat-icon>
        Applications
      </h2>
      <p class="subtitle">
        Applications déployées dans cet environnement
      </p>
    </div>

    <div class="header-actions">

      <!-- Search -->
      <mat-form-field appearance="outline" class="search-field">
        <mat-label>Rechercher une application</mat-label>
        <input matInput
               placeholder="Nom, host, protocole..."
               [(ngModel)]="searchTerm"
               (ngModelChange)="onSearchChange($event)" />

        <button *ngIf="searchTerm"
                mat-icon-button
                matSuffix
                aria-label="clear"
                (click)="clearSearch()">
          <mat-icon>close</mat-icon>
        </button>

        <button *ngIf="!searchTerm"
                mat-icon-button
                disabled
                matSuffix>
          <mat-icon>search</mat-icon>
        </button>
      </mat-form-field>

      <button mat-stroked-button (click)="goBack()">
        <mat-icon>arrow_back</mat-icon>
        Retour
      </button>

      <button mat-raised-button color="primary" (click)="addApplication()">
        <mat-icon>add</mat-icon>
        Ajouter une Application
      </button>

    </div>
  </div>

  <!-- Table -->
  @if (!loading) {
    <mat-card>

      <table mat-table [dataSource]="applications" class="applications-table">

        <!-- Application -->
        <ng-container matColumnDef="application">
          <th mat-header-cell *matHeaderCellDef>Application</th>
          <td mat-cell *matCellDef="let app">
            <div class="app-main">
              <span class="app-code">{{ app.applicationCode }}</span>
              <span class="app-libelle">{{ app.applicationLibelle }}</span>
            </div>
          </td>
        </ng-container>

        <!-- Protocole -->
        <ng-container matColumnDef="protocole">
          <th mat-header-cell *matHeaderCellDef>Protocole</th>
          <td mat-cell *matCellDef="let app">
            @if (app.protocole) {
              <mat-chip class="protocol-chip">{{ app.protocole }}</mat-chip>
            } @else {
              <span>-</span>
            }
          </td>
        </ng-container>

        <!-- Host -->
        <ng-container matColumnDef="host">
          <th mat-header-cell *matHeaderCellDef>Host</th>
          <td mat-cell *matCellDef="let app">{{ app.host || '-' }}</td>
        </ng-container>

        <!-- Port -->
        <ng-container matColumnDef="port">
          <th mat-header-cell *matHeaderCellDef>Port</th>
          <td mat-cell *matCellDef="let app">{{ app.port || '-' }}</td>
        </ng-container>

        <!-- Username -->
        <ng-container matColumnDef="username">
          <th mat-header-cell *matHeaderCellDef>Username</th>
          <td mat-cell *matCellDef="let app">{{ app.username || '-' }}</td>
        </ng-container>

        <!-- Password -->
        <ng-container matColumnDef="password">
          <th mat-header-cell *matHeaderCellDef>Password</th>
          <td mat-cell *matCellDef="let app">{{ app.password || '-' }}</td>
        </ng-container>

        <!-- URL -->
        <ng-container matColumnDef="url">
          <th mat-header-cell *matHeaderCellDef>URL</th>
          <td mat-cell *matCellDef="let app">
            @if (app.url) {
              <a class="url-link" [href]="app.url" target="_blank">{{ app.url }}</a>
            } @else {
              <span>-</span>
            }
          </td>
        </ng-container>

        <!-- Date Dernière Livraison -->
        <ng-container matColumnDef="dateDerniereLivraison">
          <th mat-header-cell *matHeaderCellDef>Dernière livraison</th>
          <td mat-cell *matCellDef="let app">
            {{ app.dateDerniereLivraison ? (app.dateDerniereLivraison | date:'short') : '-' }}
          </td>
        </ng-container>

        <!-- Actions -->
        <ng-container matColumnDef="actions">
          <th mat-header-cell *matHeaderCellDef>Actions</th>
          <td mat-cell *matCellDef="let app" class="actions-cell">

            <button mat-icon-button
                    matTooltip="Modifier"
                    color="primary"
                    (click)="editApplication(app)">
              <mat-icon>edit</mat-icon>
            </button>

            <button mat-icon-button
                    matTooltip="Supprimer"
                    color="warn"
                    (click)="deleteApplication(app)">
              <mat-icon>delete</mat-icon>
            </button>

          </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
        <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>

      </table>

      @if (!applications.length) {
        <div class="empty-state">
          <mat-icon>apps</mat-icon>
          <p>Aucune application trouvée</p>
          <p class="hint">Ajoutez une application pour cet environnement</p>
        </div>
      }

    </mat-card>
  } @else {
    <div class="loading-state">
      <mat-progress-spinner mode="indeterminate" diameter="50"></mat-progress-spinner>
      <p>Chargement des applications...</p>
    </div>
  }

</div>
