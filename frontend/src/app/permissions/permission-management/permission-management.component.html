<!-- src/app/permissions/components/permission-management/permission-management.component.html -->

<div class="permission-page">

  <div class="page-header">
    <div>
      <h1>Gestion des Permissions</h1>
      <p class="subtitle">
        Configuration en 2 étapes : types d'environnement puis actions par projet
      </p>
    </div>
  </div>

  <div class="card profil-selector">
    <mat-form-field appearance="outline" class="full-width">
      <mat-label>Sélectionnez un profil</mat-label>
      <mat-select
        [(value)]="selectedProfilId"
        (selectionChange)="onProfilChange($event.value)"
        [disabled]="loading"
        panelClass="profil-select-panel">
        @for (profil of profils; track profil.id) {
          <mat-option [value]="profil.id">
            {{ profil.libelle }} ({{ profil.code }})
          </mat-option>
        }
      </mat-select>
    </mat-form-field>
  </div>

  @if (isAdminProfile && permissions) {
    <mat-card class="admin-notice">
      <mat-card-content>
        <div class="notice-content">
          <mat-icon class="notice-icon">admin_panel_settings</mat-icon>
          <div class="notice-text">
            <strong>Profil Administrateur</strong>
            <p>Ce profil dispose de tous les droits. Les permissions ne peuvent pas être modifiées.</p>
          </div>
        </div>
      </mat-card-content>
    </mat-card>
  }

  @if (loading && !permissions) {
    <div class="loading-zone">
      <mat-progress-spinner mode="indeterminate" diameter="50"></mat-progress-spinner>
      <p>Chargement des permissions...</p>
    </div>
  }

  @if (permissions && !loading) {
    <mat-stepper #stepper [selectedIndex]="currentStep" [linear]="false">

      <mat-step>
        <ng-template matStepLabel>Types d'Environnement</ng-template>

        <mat-card class="permission-module">
          <mat-card-header>
            <mat-card-title>
              <mat-icon>dns</mat-icon>
              Étape 1 : Types d'environnement
            </mat-card-title>
            <mat-card-subtitle>
              Sélectionnez les actions par type (consulter / créer des projets)
            </mat-card-subtitle>
          </mat-card-header>

          <mat-card-content>
            <div class="env-type-grid">
              @for (envType of permissions.envTypePermissions; track envType.typeCode) {
                <div class="env-type-row simple">
                  <div class="env-type-label">
                    <strong>{{ envType.typeLibelle }}</strong>
                    <span class="env-type-code">{{ envType.typeCode }}</span>
                  </div>
                  <div class="actions-checkboxes">
                    <mat-checkbox
                      [checked]="isEnvActionChecked(envType.typeCode, 'CONSULT')"
                      [disabled]="isAdminProfile"
                      (change)="toggleEnvAction(envType.typeCode, 'CONSULT')"
                      color="primary">
                      Consulter
                    </mat-checkbox>
                    <mat-checkbox
                      [checked]="isEnvActionChecked(envType.typeCode, 'CREATE')"
                      [disabled]="isAdminProfile"
                      (change)="toggleEnvAction(envType.typeCode, 'CREATE')"
                      color="primary">
                      Créer des projets
                    </mat-checkbox>
                  </div>
                </div>
              }
            </div>
          </mat-card-content>

          <mat-card-actions>
            <button
              mat-raised-button
              color="primary"
              (click)="nextStep()"
              [disabled]="!canProceedToStep2() || isAdminProfile">
              Suivant : Configurer les actions par projet
              <mat-icon>arrow_forward</mat-icon>
            </button>

            @if (isAdminProfile) {
              <span class="admin-hint">
                <mat-icon>info</mat-icon>
                Les administrateurs ont tous les droits automatiquement
              </span>
            }
          </mat-card-actions>
        </mat-card>
      </mat-step>

      <mat-step>
        <ng-template matStepLabel>Actions par Projet</ng-template>

        <mat-card class="permission-module">
          <mat-card-header>
            <mat-card-title>
              <mat-icon>folder</mat-icon>
              Étape 2 : Actions par projet
            </mat-card-title>
            <mat-card-subtitle>
              Définissez les actions autorisées pour chaque projet filtré par type
            </mat-card-subtitle>
          </mat-card-header>

          <mat-card-content>
            @if (filteredProjects.length === 0) {
              <div class="empty-state">
                <mat-icon>info</mat-icon>
                <p>Aucun projet disponible pour les types sélectionnés.</p>
                <button mat-stroked-button (click)="previousStep()">
                  <mat-icon>arrow_back</mat-icon>
                  Retour aux types
                </button>
              </div>
            } @else {
              <div class="env-type-grid">
                @for (proj of filteredProjects; track proj.projectId) {
                  <div class="env-type-row">

                    <div class="env-type-label">
                      <strong>{{ proj.projectLibelle }}</strong>
                      <span class="env-type-code">{{ proj.projectCode }}</span>
                    </div>

                    <div class="actions-checkboxes">
                      @for (action of allActions; track action) {
                        <mat-checkbox
                          [checked]="isProjectActionChecked(proj.projectId, action)"
                          [disabled]="isAdminProfile"
                          (change)="toggleProjectAction(proj.projectId, action)"
                          color="primary">
                          {{ action }}
                        </mat-checkbox>
                      }
                    </div>

                  </div>
                }
              </div>
            }
          </mat-card-content>

          <mat-card-actions class="step-actions">
            <button
              mat-stroked-button
              (click)="previousStep()"
              [disabled]="isAdminProfile">
              <mat-icon>arrow_back</mat-icon>
              Précédent
            </button>

            <button
              mat-stroked-button
              (click)="cancel()"
              [disabled]="saving">
              Annuler
            </button>

            <button
              mat-raised-button
              color="primary"
              (click)="save()"
              [disabled]="saving || isAdminProfile">
              @if (saving) {
                <mat-progress-spinner
                  mode="indeterminate"
                  diameter="16"
                  strokeWidth="2">
                </mat-progress-spinner>
                <span>Enregistrement...</span>
              } @else {
                <mat-icon>save</mat-icon>
                <span>Enregistrer les permissions</span>
              }
            </button>
          </mat-card-actions>
        </mat-card>
      </mat-step>

    </mat-stepper>
  }
</div>
