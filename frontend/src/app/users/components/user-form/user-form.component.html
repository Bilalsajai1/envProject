<div class="user-form-page">

  <!-- HEADER -->
  <div class="user-form-header">
    <div class="title-block">
      <div class="avatar" [ngClass]="{ 'edit': isEdit, 'create': !isEdit }">
        <mat-icon>{{ isEdit ? 'person' : 'person_add_alt_1' }}</mat-icon>
      </div>
      <div class="title-text">
        <h1>{{ isEdit ? 'Modifier un utilisateur' : 'Nouvel utilisateur' }}</h1>
        <p>
          {{ isEdit
          ? 'Mettez à jour les informations et le profil de ce compte.'
          : 'Créez un nouveau compte utilisateur avec profil et statut.' }}
        </p>
      </div>
    </div>

    <button
      mat-icon-button
      class="close-button"
      (click)="cancel()"
      aria-label="Fermer">
      <mat-icon>close</mat-icon>
    </button>
  </div>

  @if (loading) {
    <mat-progress-bar
      mode="indeterminate"
      color="primary"
      class="loading-bar">
    </mat-progress-bar>
  }

  <!-- CONTENU SCROLLABLE -->
  <div class="user-form-content">
    <form [formGroup]="form" (ngSubmit)="submit()">

      <div class="sections-grid">

        <!-- SECTION 1 : INFOS PERSO -->
        <section class="form-section">
          <div class="section-header">
            <div class="section-icon">
              <mat-icon>person_outline</mat-icon>
            </div>
            <div>
              <h2>Informations personnelles</h2>
              <p>Identité et coordonnées principales de l'utilisateur.</p>
            </div>
          </div>

          <div class="section-body">
            <!-- CODE UTILISATEUR -->
            <div class="fields-row">
              <mat-form-field appearance="outline" class="full-width">
                <mat-label>Code utilisateur</mat-label>
                <mat-icon matPrefix>qr_code_2</mat-icon>
                <input
                  matInput
                  formControlName="code"
                  placeholder="Ex: USR001"
                  [attr.aria-label]="'Code utilisateur'" />
                <mat-hint align="start">Code unique de l'utilisateur</mat-hint>

                @if (codeControl?.hasError('required')) {
                  <mat-error>Le code est obligatoire</mat-error>
                }
                @if (codeControl?.hasError('minlength')) {
                  <mat-error>Minimum 3 caractères requis</mat-error>
                }
                @if (codeControl?.hasError('maxlength')) {
                  <mat-error>Maximum 50 caractères autorisés</mat-error>
                }
              </mat-form-field>
            </div>

            <!-- PRÉNOM & NOM -->
            <div class="fields-row two-cols">
              <mat-form-field appearance="outline">
                <mat-label>Prénom</mat-label>
                <mat-icon matPrefix>face</mat-icon>
                <input
                  matInput
                  formControlName="firstName"
                  placeholder="Prénom"
                  [attr.aria-label]="'Prénom'" />
                <mat-error>{{ getErrorMessage('firstName') }}</mat-error>
              </mat-form-field>

              <mat-form-field appearance="outline">
                <mat-label>Nom</mat-label>
                <mat-icon matPrefix>badge</mat-icon>
                <input
                  matInput
                  formControlName="lastName"
                  placeholder="Nom de famille"
                  [attr.aria-label]="'Nom de famille'" />
                <mat-error>{{ getErrorMessage('lastName') }}</mat-error>
              </mat-form-field>
            </div>

            <!-- EMAIL -->
            <div class="fields-row">
              <mat-form-field appearance="outline" class="full-width">
                <mat-label>Adresse email</mat-label>
                <mat-icon matPrefix>alternate_email</mat-icon>
                <input
                  matInput
                  type="email"
                  formControlName="email"
                  placeholder="utilisateur@example.com"
                  autocomplete="email"
                  [attr.aria-label]="'Adresse email'" />
                <mat-hint align="start">Email professionnel de l'utilisateur</mat-hint>
                <mat-error>{{ getErrorMessage('email') }}</mat-error>
              </mat-form-field>
            </div>
          </div>
        </section>

        <!-- SECTION 2 : COMPTE & PROFIL -->
        <section class="form-section">
          <div class="section-header">
            <div class="section-icon section-icon-secondary">
              <mat-icon>admin_panel_settings</mat-icon>
            </div>
            <div>
              <h2>Compte & profil</h2>
              <p>Rôle dans la plateforme et activation du compte.</p>
            </div>
          </div>

          <div class="section-body">

            <!-- PROFIL -->
            <div class="fields-row">
              <mat-form-field appearance="outline" class="full-width">
                <mat-label>Profil</mat-label>
                <mat-icon matPrefix>workspace_premium</mat-icon>
                <mat-select
                  formControlName="profilId"
                  placeholder="Sélectionner un profil"
                  panelClass="profil-panel"
                  [attr.aria-label]="'Profil utilisateur'">

                  <!-- Ce qui s'affiche DANS LE CHAMP quand un profil est sélectionné -->
                  <mat-select-trigger>
                    {{ getSelectedProfilCode() }}
                  </mat-select-trigger>


                  @if (profilsLoading) {
                    <mat-option disabled>
                      <mat-spinner diameter="20"></mat-spinner>
                      <span style="margin-left: 8px;">Chargement...</span>
                    </mat-option>
                  }

                  @for (p of profils; track p.id) {
                    <mat-option [value]="p.id">
                      <div class="profil-option">
                        <span class="profil-libelle">{{ p.libelle }}</span>
                        <span class="profil-code">{{ p.code }}</span>
                      </div>
                    </mat-option>
                  }
                </mat-select>
                <mat-hint align="start">Le profil détermine les accès et permissions.</mat-hint>

                @if (profilIdControl?.hasError('required')) {
                  <mat-error>Le profil est obligatoire</mat-error>
                }
              </mat-form-field>
            </div>

            <!-- MOT DE PASSE (uniquement en création) -->
            @if (!isEdit) {
              <div class="fields-row password-field">
                <mat-form-field appearance="outline" class="full-width">
                  <mat-label>Mot de passe</mat-label>
                  <mat-icon matPrefix>lock</mat-icon>
                  <input
                    matInput
                    [type]="hidePassword ? 'password' : 'text'"
                    formControlName="password"
                    placeholder="Minimum 8 caractères"
                    autocomplete="new-password"
                    [attr.aria-label]="'Mot de passe'" />
                  <button
                    mat-icon-button
                    matSuffix
                    type="button"
                    (click)="hidePassword = !hidePassword"
                    [attr.aria-label]="hidePassword ? 'Afficher le mot de passe' : 'Masquer le mot de passe'"
                    [attr.aria-pressed]="!hidePassword"
                    tabindex="-1">
                    <mat-icon>{{ hidePassword ? 'visibility_off' : 'visibility' }}</mat-icon>
                  </button>
                  <mat-hint align="start">Mot de passe initial pour l'utilisateur</mat-hint>

                  @if (passwordControl?.hasError('required')) {
                    <mat-error>Le mot de passe est obligatoire</mat-error>
                  }
                  @if (passwordControl?.hasError('minlength')) {
                    <mat-error>Le mot de passe doit contenir au moins 8 caractères</mat-error>
                  }
                </mat-form-field>
              </div>
            }

            <!-- STATUT DU COMPTE -->
            <div class="status-block">
              <div class="status-header">
                <div
                  class="status-badge"
                  [ngClass]="{ 'badge-active': actifControl?.value, 'badge-inactive': !actifControl?.value }">
                  <mat-icon>
                    {{ actifControl?.value ? 'verified_user' : 'lock_person' }}
                  </mat-icon>
                </div>
                <div class="status-text">
                  <span class="status-title">Statut du compte</span>
                  <span class="status-sub">
                    {{ actifControl?.value ? 'Compte actif et opérationnel' : 'Compte désactivé' }}
                  </span>
                </div>
              </div>

              <!-- Toggle custom -->
              <div class="status-toggle-pill" role="group" aria-label="Statut du compte">
                <button
                  type="button"
                  class="pill-button pill-active"
                  [class.selected]="actifControl?.value"
                  (click)="setActif(true)"
                  [attr.aria-pressed]="actifControl?.value"
                  aria-label="Activer le compte">
                  <mat-icon>check_circle</mat-icon>
                  <span>Actif</span>
                </button>

                <button
                  type="button"
                  class="pill-button pill-inactive"
                  [class.selected]="!actifControl?.value"
                  (click)="setActif(false)"
                  [attr.aria-pressed]="!actifControl?.value"
                  aria-label="Désactiver le compte">
                  <mat-icon>pause_circle</mat-icon>
                  <span>Inactif</span>
                </button>
              </div>
            </div>

          </div>
        </section>

      </div>

      <!-- FOOTER -->
      <div class="form-footer">
        <div class="footer-info">
          <mat-icon class="info-icon">info</mat-icon>
          <span class="info-text">
            {{ isEdit
            ? 'Les modifications seront appliquées immédiatement sur ce compte.'
            : 'Le compte pourra être activé/désactivé à tout moment après la création.' }}
          </span>
        </div>

        <div class="footer-actions">
          <button
            mat-stroked-button
            type="button"
            (click)="cancel()"
            [disabled]="saving"
            class="cancel-button"
            aria-label="Annuler">
            <mat-icon>close</mat-icon>
            <span>Annuler</span>
          </button>

          <button
            mat-raised-button
            color="primary"
            type="submit"
            [disabled]="saving || form.invalid"
            class="submit-button"
            [attr.aria-label]="isEdit ? 'Enregistrer les modifications' : 'Créer l\'utilisateur'">
            @if (saving) {
              <mat-spinner
                diameter="20"
                strokeWidth="3"
                class="button-spinner">
              </mat-spinner>
              <span>Enregistrement...</span>
            } @else {
              <mat-icon>{{ isEdit ? 'save' : 'add' }}</mat-icon>
              <span>{{ isEdit ? 'Enregistrer' : 'Créer' }}</span>
            }
          </button>
        </div>
      </div>

    </form>
  </div>
</div>
