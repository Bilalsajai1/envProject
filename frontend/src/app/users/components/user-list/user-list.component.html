<div class="users-page">

  <!-- HEADER -->
  <header class="page-header">
    <div class="header-content">
      <div class="header-icon">
        <mat-icon>group</mat-icon>
      </div>
      <div class="header-text">
        <h1>Gestion des utilisateurs</h1>
        <p>Gérez les comptes, profils et permissions de votre équipe</p>
      </div>
    </div>
    <div class="header-actions">
      <button mat-icon-button class="action-icon-btn" (click)="refresh()" matTooltip="Actualiser">
        <mat-icon>refresh</mat-icon>
      </button>
      <button mat-raised-button class="add-user-btn" (click)="addUser()">
        <mat-icon>person_add</mat-icon>
        <span>Nouvel utilisateur</span>
      </button>
    </div>
  </header>

  <!-- FILTERS & SEARCH -->
  <section class="filters-section">
    <div class="filters-bar">
      <!-- Search -->
      <div class="search-box">
        <mat-icon class="search-icon">search</mat-icon>
        <input
          type="text"
          class="search-input"
          placeholder="Rechercher par nom, email, code..."
          [value]="searchTerm"
          (input)="onSearchChange($any($event.target).value)"
        />
        @if (searchTerm) {
          <button class="clear-search-btn" (click)="clearSearch()" matTooltip="Effacer">
            <mat-icon>close</mat-icon>
          </button>
        }
      </div>

      <!-- Status Filter Tabs -->
      <div class="status-tabs">
        <button
          class="status-tab"
          [class.active]="filterStatus === 'all'"
          (click)="setFilterStatus('all')">
          <mat-icon>list</mat-icon>
          <span>Tous</span>
        </button>
        <button
          class="status-tab"
          [class.active]="filterStatus === 'active'"
          (click)="setFilterStatus('active')">
          <mat-icon>check_circle</mat-icon>
          <span>Actifs</span>
        </button>
        <button
          class="status-tab"
          [class.active]="filterStatus === 'inactive'"
          (click)="setFilterStatus('inactive')">
          <mat-icon>pause_circle</mat-icon>
          <span>Inactifs</span>
        </button>
      </div>

      <!-- View Toggle -->
      <button
        mat-icon-button
        class="view-toggle-btn"
        (click)="toggleViewMode()"
        [matTooltip]="viewMode === 'table' ? 'Vue grille' : 'Vue tableau'">
        <mat-icon>{{ viewMode === 'table' ? 'grid_view' : 'view_list' }}</mat-icon>
      </button>
    </div>

    <!-- Results count -->
    @if (!loading && hasFilters) {
      <div class="results-info">
        <mat-icon>filter_list</mat-icon>
        <span>{{ resultsLabel }} trouvé(s)</span>
        <button class="clear-filters-btn" (click)="clearSearch()">
          <mat-icon>close</mat-icon>
          Effacer les filtres
        </button>
      </div>
    }
  </section>

  <!-- CONTENT -->
  <section class="content-section">

    <!-- TABLE VIEW -->
    @if (viewMode === 'table') {
      <div class="table-container">
        <div class="table-wrapper" [class.blurred]="loading">
          <table mat-table [dataSource]="users" matSort (matSortChange)="onSortChange($event)" class="users-table">

            <!-- Code Column -->
            <ng-container matColumnDef="code">
              <th mat-header-cell *matHeaderCellDef mat-sort-header>Code</th>
              <td mat-cell *matCellDef="let user">
                <span class="code-badge">{{ user.code }}</span>
              </td>
            </ng-container>

            <!-- First Name Column -->
            <ng-container matColumnDef="firstName">
              <th mat-header-cell *matHeaderCellDef mat-sort-header>Prénom</th>
              <td mat-cell *matCellDef="let user">{{ user.firstName }}</td>
            </ng-container>

            <!-- Last Name Column -->
            <ng-container matColumnDef="lastName">
              <th mat-header-cell *matHeaderCellDef mat-sort-header>Nom</th>
              <td mat-cell *matCellDef="let user">
                <strong>{{ user.lastName }}</strong>
              </td>
            </ng-container>

            <!-- Email Column -->
            <ng-container matColumnDef="email">
              <th mat-header-cell *matHeaderCellDef>Email</th>
              <td mat-cell *matCellDef="let user">
                @if (user.email) {
                  <a [href]="'mailto:' + user.email" class="email-link" [matTooltip]="user.email">
                    {{ user.email }}
                  </a>
                } @else {
                  <span class="text-muted">—</span>
                }
              </td>
            </ng-container>

            <!-- Profile Column -->
            <ng-container matColumnDef="profilLibelle">
              <th mat-header-cell *matHeaderCellDef>Profil</th>
              <td mat-cell *matCellDef="let user">
                @if (user.profilLibelle) {
                  <span class="profile-chip">
                    <mat-icon>workspace_premium</mat-icon>
                    {{ user.profilLibelle }}
                  </span>
                } @else {
                  <span class="text-muted">Aucun profil</span>
                }
              </td>
            </ng-container>

            <!-- Status Column -->
            <ng-container matColumnDef="actif">
              <th mat-header-cell *matHeaderCellDef mat-sort-header>Statut</th>
              <td mat-cell *matCellDef="let user">
                <span class="status-badge" [class.active]="user.actif" [class.inactive]="!user.actif">
                  <mat-icon>{{ user.actif ? 'check_circle' : 'pause_circle' }}</mat-icon>
                  {{ user.actif ? 'Actif' : 'Inactif' }}
                </span>
              </td>
            </ng-container>

            <!-- Actions Column -->
            <ng-container matColumnDef="actions">
              <th mat-header-cell *matHeaderCellDef>Actions</th>
              <td mat-cell *matCellDef="let user">
                <div class="inline-actions">
                  <button mat-icon-button class="action-edit" (click)="editUser(user)" matTooltip="Modifier">
                    <mat-icon>edit</mat-icon>
                  </button>
                  <button mat-icon-button class="action-delete" (click)="deleteUser(user)" matTooltip="Supprimer">
                    <mat-icon>delete</mat-icon>
                  </button>
                </div>
              </td>
            </ng-container>

            <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
            <tr mat-row *matRowDef="let row; columns: displayedColumns" class="user-row"></tr>
          </table>

          <!-- Empty State -->
          @if (isEmpty) {
            <div class="empty-state">
              <div class="empty-icon">
                <mat-icon>person_off</mat-icon>
              </div>
              <h3>Aucun utilisateur trouvé</h3>
              <p>
                @if (hasFilters) {
                  Aucun résultat ne correspond à vos critères de recherche.
                } @else {
                  Commencez par créer votre premier utilisateur.
                }
              </p>
              @if (hasFilters) {
                <button mat-stroked-button (click)="clearSearch()">
                  <mat-icon>refresh</mat-icon>
                  Réinitialiser les filtres
                </button>
              } @else {
                <button mat-raised-button class="add-user-btn" (click)="addUser()">
                  <mat-icon>person_add</mat-icon>
                  Créer un utilisateur
                </button>
              }
            </div>
          }

          <!-- Loading Overlay -->
          @if (loading) {
            <div class="loading-overlay">
              <mat-progress-spinner mode="indeterminate" diameter="56"></mat-progress-spinner>
              <p>Chargement des utilisateurs...</p>
            </div>
          }
        </div>

        <!-- Pagination -->
        @if (!isEmpty) {
          <mat-paginator
            [length]="totalElements"
            [pageSize]="size"
            [pageIndex]="page"
            [pageSizeOptions]="pageSizeOptions"
            showFirstLastButtons
            (page)="onPageChange($event)">
          </mat-paginator>
        }
      </div>
    }

    <!-- GRID VIEW -->
    @if (viewMode === 'grid') {
      <div class="grid-container">
        <div class="users-grid" [class.blurred]="loading">
          @for (user of users; track trackByUser($index, user)) {
            <div class="user-card">
              <div class="user-card-header">
                <div class="user-avatar">
                  {{ getUserInitials(user) }}
                </div>
                <div class="user-card-actions inline-actions">
                  <button mat-icon-button class="action-edit" (click)="editUser(user)" matTooltip="Modifier">
                    <mat-icon>edit</mat-icon>
                  </button>
                  <button mat-icon-button class="action-delete" (click)="deleteUser(user)" matTooltip="Supprimer">
                    <mat-icon>delete</mat-icon>
                  </button>
                </div>
              </div>

              <div class="user-card-body">
                <h3 class="user-name">{{ user.firstName }} {{ user.lastName }}</h3>
                <span class="code-badge small">{{ user.code }}</span>

                @if (user.email) {
                  <div class="user-email">
                    <mat-icon>alternate_email</mat-icon>
                    <a [href]="'mailto:' + user.email">{{ user.email }}</a>
                  </div>
                }

                @if (user.profilLibelle) {
                  <div class="user-profile">
                    <mat-icon>workspace_premium</mat-icon>
                    <span>{{ user.profilLibelle }}</span>
                  </div>
                }
              </div>

              <div class="user-card-footer">
                <span class="status-badge" [class.active]="user.actif" [class.inactive]="!user.actif">
                  <mat-icon>{{ user.actif ? 'check_circle' : 'pause_circle' }}</mat-icon>
                  {{ user.actif ? 'Actif' : 'Inactif' }}
                </span>
              </div>
            </div>
          }

          <!-- Empty State for Grid -->
          @if (isEmpty) {
            <div class="empty-state-grid">
              <div class="empty-icon">
                <mat-icon>person_off</mat-icon>
              </div>
              <h3>Aucun utilisateur trouvé</h3>
              <p>
                @if (hasFilters) {
                  Aucun résultat ne correspond à vos critères.
                } @else {
                  Créez votre premier utilisateur pour commencer.
                }
              </p>
              @if (hasFilters) {
                <button mat-stroked-button (click)="clearSearch()">
                  <mat-icon>refresh</mat-icon>
                  Réinitialiser
                </button>
              } @else {
                <button mat-raised-button class="add-user-btn" (click)="addUser()">
                  <mat-icon>person_add</mat-icon>
                  Créer un utilisateur
                </button>
              }
            </div>
          }
        </div>

        <!-- Loading Overlay for Grid -->
        @if (loading) {
          <div class="loading-overlay">
            <mat-progress-spinner mode="indeterminate" diameter="56"></mat-progress-spinner>
            <p>Chargement des utilisateurs...</p>
          </div>
        }

        <!-- Pagination for Grid -->
        @if (!isEmpty) {
          <div class="grid-pagination">
            <mat-paginator
              [length]="totalElements"
              [pageSize]="size"
              [pageIndex]="page"
              [pageSizeOptions]="pageSizeOptions"
              showFirstLastButtons
              (page)="onPageChange($event)">
            </mat-paginator>
          </div>
        }
      </div>
    }
  </section>
</div>
