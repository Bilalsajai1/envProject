<h2>Applications de l’environnement {{ envId }} (type {{ typeCode }})</h2>

<div class="toolbar">
  <button class="secondary" (click)="goBack()">← Retour</button>
  <button class="primary" (click)="openCreateForm()">+ Application</button>
  <button class="primary" (click)="toggleShowPassword()">
    {{ showPassword ? 'Masquer' : 'Afficher' }} les mots de passe
  </button>
</div>

@if (loading) {
  <div>Chargement...</div>
}

@if (error) {
  <div class="error">{{ error }}</div>
}

@if (showForm) {
  <div class="form-card">
    <h3>{{ isEditing ? 'Modifier une application' : 'Nouvelle application' }}</h3>

    <form (ngSubmit)="submitForm()">
      <div>
        <label>Application ID</label>
        <input type="number" [(ngModel)]="form.applicationId" name="applicationId" required />
      </div>

      <div>
        <label>Protocole</label>
        <input type="text" [(ngModel)]="form.protocole" name="protocole" />
      </div>

      <div>
        <label>Host</label>
        <input type="text" [(ngModel)]="form.host" name="host" />
      </div>

      <div>
        <label>Port</label>
        <input type="number" [(ngModel)]="form.port" name="port" />
      </div>

      <div>
        <label>URL</label>
        <input type="text" [(ngModel)]="form.url" name="url" />
      </div>

      <div>
        <label>Username</label>
        <input type="text" [(ngModel)]="form.username" name="username" />
      </div>

      <div>
        <label>Password</label>
        <input type="text" [(ngModel)]="form.password" name="password" />
      </div>

      <div>
        <label>Description</label>
        <textarea [(ngModel)]="form.description" name="description"></textarea>
      </div>

      <div>
        <label>
          <input type="checkbox" [(ngModel)]="form.actif" name="actif" />
          Actif
        </label>
      </div>

      <div class="form-actions">
        <button type="submit">
          {{ isEditing ? 'Enregistrer' : 'Créer' }}
        </button>
        <button type="button" (click)="cancelForm()">Annuler</button>
      </div>
    </form>
  </div>
}

@if (!loading && !error && applications.length > 0) {
  <table class="table">
    <thead>
    <tr>
      <th>Application</th>
      <th>Protocole</th>
      <th>Host</th>
      <th>Port</th>
      <th>URL</th>
      <th>Username</th>
      <th>Password</th>
      <th>Dernière livraison</th>
      <th>Actions</th>
    </tr>
    </thead>
    <tbody>
      @for (app of applications; track app.id) {
        <tr [class.disabled]="!app.actif">
          <td>
            {{ app.applicationCode }} - {{ app.applicationLibelle }}
            @if (!app.actif) {
              <span class="tag-disabled">Inactif</span>
            }
          </td>
          <td>{{ app.protocole }}</td>
          <td>{{ app.host }}</td>
          <td>{{ app.port }}</td>
          <td>{{ app.url }}</td>
          <td>{{ app.username }}</td>
          <td>{{ getPasswordToDisplay(app) }}</td>
          <td>{{ app.dateDerniereLivraison }}</td>
          <td>
            <button (click)="openEditForm(app)">Modifier</button>
            @if (app.actif) {
              <button class="danger" (click)="deleteApp(app)">Supprimer</button>
            }
          </td>
        </tr>
      }
    </tbody>
  </table>
}

@if (!loading && !error && applications.length === 0) {
  <div>
    Aucune application configurée pour cet environnement.
  </div>
}
