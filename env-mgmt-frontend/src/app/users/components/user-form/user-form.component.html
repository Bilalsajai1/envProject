<div class="form-page">

  <div class="page-header">
    <div class="header-content">
      <button mat-icon-button class="back-button" (click)="cancel()">
        <mat-icon>arrow_back</mat-icon>
      </button>

      <div class="header-info">
        <h1 class="page-title">
          <mat-icon class="title-icon">{{ isEdit ? 'edit' : 'person_add' }}</mat-icon>
          {{ isEdit ? 'Modifier un utilisateur' : 'Nouvel utilisateur' }}
        </h1>
        <p class="page-subtitle">
          {{ isEdit ? 'Mise à jour des informations de l\'utilisateur' : 'Création d\'un nouveau compte utilisateur' }}
        </p>
      </div>
    </div>
  </div>

  @if (loading) {
    <mat-progress-bar
      mode="indeterminate"
      color="primary"
      class="loading-bar">
    </mat-progress-bar>
  }

  <div class="form-container">
    <form [formGroup]="form" (ngSubmit)="submit()">

      <div class="form-section">
        <div class="section-header">
          <mat-icon class="section-icon">badge</mat-icon>
          <h2 class="section-title">Informations de base</h2>
        </div>

        <div class="form-grid">
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Code utilisateur</mat-label>
            <mat-icon matPrefix>fingerprint</mat-icon>
            <input matInput formControlName="code" placeholder="Ex: USR001" />
            <mat-hint align="start">Code unique de l'utilisateur</mat-hint>

            @if (codeControl?.hasError('required')) {
              <mat-error>
                Le code est obligatoire
              </mat-error>
            } @if (codeControl?.hasError('minlength')) {
            <mat-error>
              Minimum 3 caractères requis
            </mat-error>
          } @if (codeControl?.hasError('maxlength')) {
            <mat-error>
              Maximum 50 caractères autorisés
            </mat-error>
          }
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Prénom</mat-label>
            <mat-icon matPrefix>person</mat-icon>
            <input matInput formControlName="firstName" placeholder="Prénom" />
            <mat-error>{{ getErrorMessage('firstName') }}</mat-error>
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Nom</mat-label>
            <mat-icon matPrefix>person_outline</mat-icon>
            <input matInput formControlName="lastName" placeholder="Nom de famille" />
            <mat-error>{{ getErrorMessage('lastName') }}</mat-error>
          </mat-form-field>

          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Adresse email</mat-label>
            <mat-icon matPrefix>email</mat-icon>
            <input matInput
                   type="email"
                   formControlName="email"
                   placeholder="utilisateur@example.com" />
            <mat-hint align="start">Email professionnel de l'utilisateur</mat-hint>
            <mat-error>{{ getErrorMessage('email') }}</mat-error>
          </mat-form-field>
        </div>
      </div>

      <div class="form-section">
        <div class="section-header">
          <mat-icon class="section-icon">settings</mat-icon>
          <h2 class="section-title">Profil et statut</h2>
        </div>

        <div class="form-grid">
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Profil</mat-label>
            <mat-icon matPrefix>shield</mat-icon>
            <mat-select formControlName="profilId" placeholder="Sélectionner un profil" panelClass="profil-panel">
              @if (profilsLoading) {
                <mat-option disabled>
                  <mat-spinner diameter="20"></mat-spinner>
                  Chargement...
                </mat-option>
              }
              @for (p of profils; track p.id) {
                <mat-option [value]="p.id">
                  <div class="profil-option">
                    <span class="profil-libelle">{{ p.libelle }}</span>
                    <span class="profil-code">{{ p.code }}</span>
                  </div>
                </mat-option>
              }
            </mat-select>
            <mat-hint align="start">Détermine les permissions de l'utilisateur</mat-hint>

            @if (profilIdControl?.hasError('required')) {
              <mat-error>
                Le profil est obligatoire
              </mat-error>
            }
          </mat-form-field>

          <div class="status-toggle">
            <div class="toggle-header">
              <mat-icon class="toggle-icon">{{ actifControl?.value ? 'check_circle' : 'cancel' }}</mat-icon>
              <div class="toggle-info">
                <span class="toggle-label">Statut du compte</span>
                <span class="toggle-description">
                  {{ actifControl?.value ? 'Compte actif et accessible' : 'Compte désactivé' }}
                </span>
              </div>
            </div>
            <mat-slide-toggle
              formControlName="actif"
              color="primary"
              class="status-slide-toggle">
              {{ actifControl?.value ? 'Actif' : 'Inactif' }}
            </mat-slide-toggle>
          </div>
        </div>
      </div>

      <div class="form-actions">
        <div class="actions-info">
          <mat-icon class="info-icon">info</mat-icon>
          <span class="info-text">
            {{ isEdit ? 'Les modifications seront appliquées immédiatement' : 'L\'utilisateur recevra un email de bienvenue' }}
          </span>
        </div>

        <div class="actions-buttons">
          <button mat-stroked-button
                  type="button"
                  (click)="cancel()"
                  [disabled]="saving"
                  class="cancel-button">
            <mat-icon>close</mat-icon>
            <span>Annuler</span>
          </button>

          <button mat-raised-button
                  color="primary"
                  type="submit"
                  [disabled]="saving || form.invalid"
                  class="submit-button">
            @if (saving) {
              <mat-spinner diameter="20"
                           strokeWidth="3"
                           class="button-spinner">
              </mat-spinner>
              <span>Enregistrement...</span>
            } @else {
              <mat-icon>{{ isEdit ? 'save' : 'add' }}</mat-icon>
              <span>{{ isEdit ? 'Enregistrer' : 'créer' }}</span>
            }
          </button>
        </div>
      </div>

    </form>
  </div>

</div>
