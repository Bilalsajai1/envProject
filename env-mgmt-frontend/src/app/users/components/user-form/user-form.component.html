<div class="form-container" *ngIf="!loading; else loadingTpl">
  <div class="form-header">
    <div>
      <h1>{{ isEdit ? 'Modifier un utilisateur' : 'Nouvel utilisateur' }}</h1>
      <p class="subtitle">
        {{ isEdit ? 'Mise à jour des informations' : 'Création d\'un nouveau compte' }}
      </p>
    </div>

    <button mat-button type="button" (click)="cancel()">
      <mat-icon>arrow_back</mat-icon>
      Retour à la liste
    </button>
  </div>

  <form [formGroup]="form" (ngSubmit)="submit()" class="user-form">
    <div class="form-grid">
      <mat-form-field appearance="outline">
        <mat-label>Code</mat-label>
        <input matInput formControlName="code" />
        <mat-error *ngIf="form.get('code')?.hasError('required')">
          Code obligatoire
        </mat-error>
      </mat-form-field>

      <mat-form-field appearance="outline">
        <mat-label>Prénom</mat-label>
        <input matInput formControlName="firstName" />
        <mat-error *ngIf="form.get('firstName')?.hasError('required')">
          Prénom obligatoire
        </mat-error>
      </mat-form-field>

      <mat-form-field appearance="outline">
        <mat-label>Nom</mat-label>
        <input matInput formControlName="lastName" />
        <mat-error *ngIf="form.get('lastName')?.hasError('required')">
          Nom obligatoire
        </mat-error>
      </mat-form-field>

      <mat-form-field appearance="outline">
        <mat-label>Email</mat-label>
        <input matInput formControlName="email" />
        <mat-error *ngIf="form.get('email')?.hasError('required')">
          Email obligatoire
        </mat-error>
        <mat-error *ngIf="form.get('email')?.hasError('email')">
          Email invalide
        </mat-error>
      </mat-form-field>

      <mat-form-field appearance="outline">
        <mat-label>Profil</mat-label>
        <mat-select formControlName="profilId">
          <mat-option *ngFor="let p of profils" [value]="p.id">
            {{ p.libelle }} ({{ p.code }})
          </mat-option>
        </mat-select>
        <mat-error *ngIf="form.get('profilId')?.hasError('required')">
          Profil obligatoire
        </mat-error>
      </mat-form-field>

      <mat-slide-toggle formControlName="actif">
        Actif
      </mat-slide-toggle>
    </div>

    <div class="form-actions">
      <button mat-stroked-button type="button" (click)="cancel()">
        Annuler
      </button>

      <button mat-raised-button color="primary" type="submit" [disabled]="saving">
        <mat-progress-spinner
          *ngIf="saving"
          mode="indeterminate"
          diameter="16"
          strokeWidth="2">
        </mat-progress-spinner>
        <span *ngIf="!saving">
          {{ isEdit ? 'Enregistrer' : 'Créer' }}
        </span>
      </button>
    </div>
  </form>
</div>

<ng-template #loadingTpl>
  <div class="loading">
    <mat-progress-spinner mode="indeterminate" diameter="40"></mat-progress-spinner>
  </div>
</ng-template>
