<mat-sidenav-container class="layout-container" autosize>

  <mat-sidenav
    mode="side"
    opened
    class="sidenav"
    [class.collapsed]="isSidebarCollapsed"
    role="navigation"
    aria-label="Navigation principale">

    <div class="sidebar-header">
      <div class="logo-container" [class.collapsed]="isSidebarCollapsed">
        <div class="logo-icon">
          @if (!isSidebarCollapsed) {
            <img
              src="/assets/images/icones/logo-perenity-software.svg"
              alt="Logo Perenity Software"
              class="logo-full"
            />
          }
          @if (isSidebarCollapsed) {
            <img
              src="/assets/images/perenity_software.png"
              alt="Logo Perenity"
              class="logo-compact"
            />
          }
        </div>
      </div>

      <button
        mat-icon-button
        class="toggle-btn"
        (click)="toggleSidebar()"
        [matTooltip]="isSidebarCollapsed ? 'Agrandir le menu' : 'Réduire le menu'"
        matTooltipPosition="right"
        [attr.aria-label]="isSidebarCollapsed ? 'Agrandir le menu' : 'Réduire le menu'">
        <mat-icon>{{ isSidebarCollapsed ? 'chevron_right' : 'chevron_left' }}</mat-icon>
      </button>
    </div>

    @if (context?.user; as u) {
      <div class="user-block">
        <div
          class="user-avatar"
          [attr.aria-label]="'Avatar de ' + userDisplayName">
          {{ getUserInitials() }}
        </div>

        @if (!isSidebarCollapsed) {
          <div class="user-info">
            <div class="user-name" [title]="userDisplayName">
              {{ userDisplayName }}
            </div>

            @if (userProfilLabel) {
              <div
                class="user-profil"
                [title]="userProfilLabel">
                {{ userProfilLabel }}
              </div>
            } @else {
              <div class="user-profil muted">Profil non défini</div>
            }

            <div class="user-email" [title]="userEmail">
              {{ userEmail }}
            </div>
          </div>
        }
      </div>
    }

    <nav class="nav-container" [attr.aria-label]="'Menu principal'">
      <mat-nav-list class="menu-list">

        @if (visibleAdminMenu.length > 0) {
          @if (!isSidebarCollapsed) {
            <div class="nav-section-label">
              Administration
            </div>
          }

          @for (item of visibleAdminMenu; track item.label) {
            <a
              mat-list-item
              [routerLink]="item.route"
              routerLinkActive="active"
              [routerLinkActiveOptions]="{exact: false}"
              [matTooltip]="isSidebarCollapsed ? item.label : ''"
              matTooltipPosition="right"
              [matTooltipDisabled]="!isSidebarCollapsed"
              [attr.aria-label]="item.label">
              @if (item.icon) {
                <mat-icon class="nav-icon">{{ item.icon }}</mat-icon>
              }
              @if (!isSidebarCollapsed) {
                <span class="nav-label">{{ item.label }}</span>
              }
            </a>
          }
        }

        @if (visibleAdminMenu.length > 0 && hasEnvMenu) {
          <mat-divider></mat-divider>
        }

        @if (hasEnvMenu) {
          @if (!isSidebarCollapsed) {
            <div class="nav-section-label">
              Environnements
            </div>
          }

          @for (envItem of envMenu; track envItem.label) {
            <a
              mat-list-item
              [routerLink]="envItem.route"
              routerLinkActive="active"
              [routerLinkActiveOptions]="{exact: false}"
              [matTooltip]="isSidebarCollapsed ? envItem.label : ''"
              matTooltipPosition="right"
              [matTooltipDisabled]="!isSidebarCollapsed"
              [attr.aria-label]="envItem.label">
              <mat-icon class="nav-icon">cloud</mat-icon>
              @if (!isSidebarCollapsed) {
                <span class="nav-label">{{ envItem.label }}</span>
              }
            </a>
          }
        }

      </mat-nav-list>
    </nav>

    <div class="sidebar-footer">
      <button
        mat-button
        class="logout-button"
        (click)="logout()"
        [matTooltip]="isSidebarCollapsed ? 'Se déconnecter' : ''"
        matTooltipPosition="right"
        [matTooltipDisabled]="!isSidebarCollapsed"
        aria-label="Se déconnecter">
        <mat-icon>logout</mat-icon>
        @if (!isSidebarCollapsed) {
          <span>Se déconnecter</span>
        }
      </button>
    </div>
  </mat-sidenav>

  <mat-sidenav-content>

    <mat-toolbar class="top-toolbar" role="banner">
      <div class="toolbar-left">
        <mat-icon class="toolbar-logo" aria-hidden="true">space_dashboard</mat-icon>
        <h1 class="app-title">Environment Management</h1>
      </div>

      <span class="toolbar-spacer"></span>

      @if (context?.user; as u) {
        <div class="user-card">
          <div class="user-card-content">
            <div class="user-avatar" [attr.aria-label]="'Avatar de ' + userDisplayName">
              {{ getUserInitials() }}
            </div>

            <div class="user-details">
              <div class="user-name">{{ userDisplayName }}</div>
              <div class="user-role">
                {{ u.admin ? 'Administrateur' : 'Utilisateur' }}
              </div>
            </div>

            <mat-divider [vertical]="true"></mat-divider>

            @if (u.admin) {
              <div class="user-status admin-status">
                <mat-icon>verified_user</mat-icon>
                <span>ADMIN</span>
              </div>
            } @else {
              <div class="user-status user-status-badge">
                <mat-icon>person</mat-icon>
                <span>USER</span>
              </div>
            }
          </div>
        </div>
      }
    </mat-toolbar>

    <main class="content" role="main">
      <div class="content-inner">
        <router-outlet></router-outlet>
      </div>
    </main>

  </mat-sidenav-content>

</mat-sidenav-container>
