<div class="permission-page">

  <div class="page-header">
    <div>
      <h1>Gestion des Permissions</h1>
      <p class="subtitle">
        Configurez les permissions d'accès pour chaque profil utilisateur
      </p>
    </div>
  </div>

  <div class="card profil-selector">
    <mat-form-field appearance="outline" class="full-width">
      <mat-label>Sélectionnez un profil</mat-label>
      <mat-select
        [(value)]="selectedProfilId"
        (selectionChange)="onProfilChange($event.value)"
        [disabled]="loading"
        panelClass="profil-select-panel">
        @for (profil of profils; track profil.id) {
          <mat-option [value]="profil.id">
            {{ profil.libelle }} ({{ profil.code }})
          </mat-option>
        }
      </mat-select>
    </mat-form-field>

  </div>

  @if (loading && !permissions) {
    <div class="loading-zone">
      <mat-progress-spinner mode="indeterminate" diameter="50"></mat-progress-spinner>
      <p>Chargement des permissions...</p>
    </div>
  }

  @if (permissions && !loading) {
    <div class="permissions-container">

      <mat-card class="permission-module">
        <mat-card-header>
          <mat-card-title>
            <mat-icon>dns</mat-icon>
            Types d'Environnement
          </mat-card-title>
          <mat-card-subtitle>
            Configurez les permissions pour chaque type d'environnement (Édition, Intégration, Client)
          </mat-card-subtitle>
        </mat-card-header>

        <mat-card-content>
          <div class="env-type-grid">
            @for (envType of permissions.envTypePermissions; track envType.typeCode) {
              <div class="env-type-row">

                <div class="env-type-label">
                  <strong>{{ envType.typeLibelle }}</strong>
                  <span class="env-type-code">{{ envType.typeCode }}</span>
                </div>

                <div class="actions-checkboxes">
                  @for (action of allActions; track action) {
                    <mat-checkbox
                      [checked]="isEnvTypeActionChecked(envType.typeCode, action)"
                      (change)="toggleEnvTypeAction(envType.typeCode, action)"
                      [color]="'primary'">
                      {{ action }}
                    </mat-checkbox>
                  }
                </div>

              </div>
            }
          </div>
        </mat-card-content>
      </mat-card>

      @if (permissions.projectPermissions.length > 0) {
        <mat-card class="permission-module">
          <mat-card-header>
            <mat-card-title>
              <mat-icon>folder</mat-icon>
              Projets
            </mat-card-title>
            <mat-card-subtitle>
              Permissions par projet (consultation / création / mise à jour / suppression)
            </mat-card-subtitle>
          </mat-card-header>

          <mat-card-content>
            <div class="env-type-grid">
              @for (proj of permissions.projectPermissions; track proj.projectId) {
                <div class="env-type-row">

                  <div class="env-type-label">
                    <strong>{{ proj.projectLibelle }}</strong>
                    <span class="env-type-code">{{ proj.projectCode }}</span>
                  </div>

                  <div class="actions-checkboxes">
                    @for (action of allActions; track action) {
                      <mat-checkbox
                        [checked]="isProjectActionChecked(proj.projectId, action)"
                        (change)="toggleProjectAction(proj.projectId, action)"
                        [color]="'primary'">
                        {{ action }}
                      </mat-checkbox>
                    }
                  </div>

                </div>
              }
            </div>
          </mat-card-content>
        </mat-card>
      }

      <div class="form-actions">
        <button mat-stroked-button (click)="cancel()" [disabled]="saving">
          Annuler
        </button>

        <button
          mat-raised-button
          color="primary"
          (click)="save()"
          [disabled]="saving">
          @if (saving) {
            <mat-progress-spinner
              mode="indeterminate"
              diameter="16"
              strokeWidth="2">
            </mat-progress-spinner>
            <span>Enregistrement...</span>
          } @else {
            <mat-icon>save</mat-icon>
            <span>Enregistrer</span>
          }
        </button>
      </div>
    </div>
  }
</div>
